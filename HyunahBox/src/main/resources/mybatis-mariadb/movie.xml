<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="movie">
	<select id="list" resultType="Movie">
		SELECT A.* 
		FROM (	
				SELECT	
				<!--  ROW_NUMBER() OVER (ORDER BY today_rank, open_date desc) AS today_rank -->
						MOVIE.MOVIE_CODE, TITLE
						, (SELECT COUNT(*) FROM HEARTMOVIE WHERE MOVIE_CODE=movie.movie_code) as "heart_cnt"
						, OPEN_DATE ,MOVIE_TIME, POSTER_URL, HEARTMOVIE.ID 
				FROM movie LEFT JOIN heartmovie ON movie.movie_code=heartmovie.movie_code
				<if test= "memId == 'noMem'">
					AND heartmovie.id is null
				</if>
				
				<if test= "memId != 'noMem'">
					AND heartmovie.id=#{memId}
				</if>
		) A 
		<!-- WHERE today_rank LIMIT 0,3 -->
		
	</select>
	
	<insert id="add">
		INSERT INTO movie(title, open_date, movie_time) VALUES(#{title}, REGEXP_REPLACE(#{openDate}, '[^0-9]', ''), #{movieTime})
	</insert>
	
	<select id="getItem" resultType="Movie">
		SELECT movie.movie_code, title, (select count(*) from heartmovie where movie_code=movie.movie_code) as "heart_cnt", OPEN_DATE, MOVIE_TIME
    	from movie where movie.movie_code = #{movieCode}
	</select>
	
	<update id="update">
		UPDATE movie
		SET title=#{title}, open_date=REGEXP_REPLACE(#{openDate}, '[^0-9]', ''), movie_time=#{movieTime}
		WHERE movie_code=#{movieCode}
	</update>
 	
 	<delete id="delete">
 		DELETE FROM movie WHERE movie_code=#{movieCode} 
 	</delete>
 	
 	
 	<delete id="clearMovieApi">
 		DELETE FROM movie_api WHERE movie_cd_kmdb IS NOT NULL AND movie_cd_kobis IS NOT NULL
 	</delete>
 	
	<insert id="addMovieApiData" parameterType="java.util.List">	
	    INSERT INTO MOVIE_API (TODAY_RANK, MOVIE_CD_KOBIS, MOVIE_CD_KMDB, TITLE, OPEN_DATE, MOVIE_TIME, POSTER_URL)
	    VALUES
	    <foreach collection="list" item="movie" separator=" , ">
	     (#{movie.todayRank}, #{movie.movieCdKobis}, #{movie.movieCdKmdb}, #{movie.title}, #{movie.openDate}, #{movie.movieTime}, #{movie.posterUrl})
	    </foreach>
	</insert>
	
	<insert id="addMovieApiMinusData">
		INSERT INTO movie(title, open_date, movie_time, movie_cd_kobis, movie_cd_kmdb, poster_url)
		SELECT DISTINCT a.title, a.open_date, a.movie_time, a.movie_cd_kobis, a.movie_cd_kmdb, a.poster_url
		FROM movie_api a
		WHERE a.movie_cd_kobis IS NOT NULL AND a.movie_cd_kmdb IS NOT NULL
		AND (a.movie_cd_kobis, a.movie_cd_kmdb) NOT IN ( SELECT movie_cd_kobis, movie_cd_kmdb FROM movie )
	</insert>
	
	
</mapper>